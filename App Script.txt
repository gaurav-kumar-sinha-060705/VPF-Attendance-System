// ===============================================================
// VPF ATTENDANCE TRACKER - GOOGLE APPS SCRIPT BACKEND (ERROR-FREE VERSION)
// ===============================================================

// --- 1. CONFIGURATION ---
const SPREADSHEET_ID = "1-sgSeFZrNFGEZKKw8mth1XQ0n_2malSIxfWzPLBbt8g";
const IMAGE_FOLDER_ID = "1R19-DUPIV6EVC7G0hba3rKMgFB8Mataq";

const EMPLOYEES_SHEET_NAME = "Employees";
const ATTENDANCE_SHEET_NAME = "AttendanceLog";

const EMPLOYEE_HEADERS = ["ID", "Name", "ReferenceImageURL"];
const ATTENDANCE_HEADERS = ["LogID", "EmployeeID", "EmployeeName", "Date", "PunchInTime", "PunchInImageURL", "PunchOutTime", "PunchOutImageURL"];

// --- 2. INITIALIZATION ---
function setupSpreadsheet() {
  try {
    Logger.log("Starting spreadsheet setup...");
    
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    
    // Setup Employees Sheet
    let employeesSheet = ss.getSheetByName(EMPLOYEES_SHEET_NAME);
    if (!employeesSheet) {
      Logger.log("Creating Employees sheet...");
      employeesSheet = ss.insertSheet(EMPLOYEES_SHEET_NAME);
      employeesSheet.getRange(1, 1, 1, EMPLOYEE_HEADERS.length).setValues([EMPLOYEE_HEADERS]);
      employeesSheet.getRange(1, 1, 1, EMPLOYEE_HEADERS.length).setFontWeight("bold");
    }
    
    // Setup Attendance Sheet
    let attendanceSheet = ss.getSheetByName(ATTENDANCE_SHEET_NAME);
    if (!attendanceSheet) {
      Logger.log("Creating Attendance sheet...");
      attendanceSheet = ss.insertSheet(ATTENDANCE_SHEET_NAME);
      attendanceSheet.getRange(1, 1, 1, ATTENDANCE_HEADERS.length).setValues([ATTENDANCE_HEADERS]);
      attendanceSheet.getRange(1, 1, 1, ATTENDANCE_HEADERS.length).setFontWeight("bold");
    }
    
    Logger.log("Setup completed successfully");
    return jsonResponse({ success: true, message: "Spreadsheet setup completed successfully" });
  } catch (error) {
    Logger.log(`Setup error: ${error.message}`);
    Logger.log(error.stack);
    return jsonResponse({ success: false, message: "Setup failed: " + error.message });
  }
}

// --- 3. MAIN ENTRY POINTS ---
function doGet(e) {
  Logger.log("doGet called");
  Logger.log("Event object: " + JSON.stringify(e));
  
  try {
    // Handle missing or null event object
    if (!e) {
      Logger.log("Event object is null or undefined");
      return jsonResponse({ success: false, message: "No event data received" });
    }
    
    // Handle missing parameter object
    if (!e.parameter) {
      Logger.log("No parameters found in event");
      return jsonResponse({ success: false, message: "No parameters provided. Try ?action=setup" });
    }
    
    const action = e.parameter.action;
    Logger.log("Action requested: " + action);
    
    switch (action) {
      case 'setup':
        return setupSpreadsheet();
      case 'getEmployees':
        return jsonResponse({ success: true, employees: getEmployees() });
      case 'getAttendance':
        return jsonResponse({ success: true, records: getAttendanceRecords() });
      case 'test':
        return jsonResponse({ success: true, message: "Script is working!", timestamp: new Date().toISOString() });
      default:
        return jsonResponse({ 
          success: false, 
          message: "Invalid action. Available actions: setup, getEmployees, getAttendance, test",
          action: action
        });
    }
  } catch (error) {
    Logger.log(`doGet Error: ${error.message}`);
    Logger.log(error.stack);
    return jsonResponse({ success: false, message: "Server error: " + error.message });
  }
}

function doPost(e) {
  Logger.log("doPost called");
  
  try {
    if (!e) {
      return jsonResponse({ success: false, message: "No event data received" });
    }
    
    if (!e.postData) {
      return jsonResponse({ success: false, message: "No POST data received" });
    }
    
    if (!e.postData.contents) {
      return jsonResponse({ success: false, message: "No POST content received" });
    }
    
    let data;
    try {
      data = JSON.parse(e.postData.contents);
      Logger.log("POST data parsed: " + JSON.stringify(data));
    } catch (parseError) {
      Logger.log("JSON parse error: " + parseError.message);
      return jsonResponse({ success: false, message: "Invalid JSON data" });
    }
    
    if (!data.action) {
      return jsonResponse({ success: false, message: "No action specified in POST data" });
    }
    
    switch (data.action) {
      case 'addEmployee':
        return jsonResponse(addEmployee(data));
      case 'deleteEmployee':
        return jsonResponse(deleteEmployee(data));
      case 'logAttendance':
        return jsonResponse(logAttendance(data));
      case 'verifyAdminToken':
        return jsonResponse(verifyAdminToken(data));
      default:
        return jsonResponse({ 
          success: false, 
          message: "Invalid POST action: " + data.action 
        });
    }
  } catch (error) {
    Logger.log(`doPost Error: ${error.message}`);
    Logger.log(error.stack);
    return jsonResponse({ success: false, message: "Server error: " + error.message });
  }
}

// --- 4. SAFE RESPONSE FUNCTION ---
function jsonResponse(obj) {
  try {
    const jsonString = JSON.stringify(obj);
    Logger.log("Creating response: " + jsonString);
    
    const response = ContentService
      .createTextOutput(jsonString)
      .setMimeType(ContentService.MimeType.JSON);
    
    return response;
  } catch (error) {
    Logger.log(`jsonResponse Error: ${error.message}`);
    // Fallback response
    const fallback = ContentService
      .createTextOutput('{"success":false,"message":"Response creation failed"}')
      .setMimeType(ContentService.MimeType.JSON);
    
    return fallback;
  }
}

// --- 5. SAFE GETTER FUNCTIONS ---
function getSpreadsheet() {
  try {
    return SpreadsheetApp.openById(SPREADSHEET_ID);
  } catch (error) {
    throw new Error(`Cannot access spreadsheet: ${error.message}`);
  }
}

function getSheet(sheetName) {
  try {
    const ss = getSpreadsheet();
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) {
      throw new Error(`Sheet "${sheetName}" not found. Please run setup first.`);
    }
    return sheet;
  } catch (error) {
    Logger.log(`getSheet error: ${error.message}`);
    throw error;
  }
}

function getImageFolder() {
  try {
    return DriveApp.getFolderById(IMAGE_FOLDER_ID);
  } catch (error) {
    throw new Error(`Cannot access image folder: ${error.message}`);
  }
}

// --- 6. DATA FUNCTIONS ---
function getEmployees() {
  try {
    const sheet = getSheet(EMPLOYEES_SHEET_NAME);
    return sheetToObjects(sheet, EMPLOYEE_HEADERS);
  } catch (error) {
    Logger.log(`getEmployees Error: ${error.message}`);
    return [];
  }
}

function getAttendanceRecords() {
  try {
    const sheet = getSheet(ATTENDANCE_SHEET_NAME);
    return sheetToObjects(sheet, ATTENDANCE_HEADERS);
  } catch (error) {
    Logger.log(`getAttendanceRecords Error: ${error.message}`);
    return [];
  }
}

function getEmployeeById(id) {
  try {
    const employees = getEmployees();
    return employees.find(e => e.ID && e.ID.toString() === id.toString());
  } catch (error) {
    Logger.log(`getEmployeeById Error: ${error.message}`);
    return null;
  }
}

// --- 7. UTILITY FUNCTIONS ---
function sheetToObjects(sheet, headers) {
  try {
    if (!sheet) return [];
    
    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return [];
    
    const data = sheet.getRange(2, 1, lastRow - 1, headers.length).getValues();
    
    return data.map(row => {
      const obj = {};
      headers.forEach((header, i) => {
        const value = row[i];
        if (value instanceof Date) {
          if (header.includes('Date')) {
            obj[header] = Utilities.formatDate(value, Session.getScriptTimeZone(), 'yyyy-MM-dd');
          } else {
            obj[header] = value.toISOString();
          }
        } else {
          obj[header] = value === "" ? null : value;
        }
      });
      return obj;
    });
  } catch (error) {
    Logger.log(`sheetToObjects Error: ${error.message}`);
    return [];
  }
}

function findRowIndex(sheet, valueToFind, column) {
  try {
    const data = sheet.getRange(1, column, sheet.getLastRow(), 1).getValues();
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] && data[i][0].toString() === valueToFind.toString()) {
        return i + 1;
      }
    }
    return -1;
  } catch (error) {
    Logger.log(`findRowIndex Error: ${error.message}`);
    return -1;
  }
}

function isSameDate(date1, date2) {
  try {
    const d1 = new Date(date1);
    const d2 = new Date(date2);
    return d1.getFullYear() === d2.getFullYear() &&
           d1.getMonth() === d2.getMonth() &&
           d1.getDate() === d2.getDate();
  } catch (error) {
    return false;
  }
}

// --- 8. LOCK SERVICE ---
function acquireLock(timeoutMs = 15000) {
  const lock = LockService.getScriptLock();
  try {
    lock.waitLock(timeoutMs);
    return lock;
  } catch (error) {
    throw new Error('Could not acquire lock: ' + error.message);
  }
}

// --- 9. FILE OPERATIONS ---
function createImageFile(imageBase64, mimeType, filename) {
  try {
    const folder = getImageFolder();
    const imageBlob = Utilities.newBlob(
      Utilities.base64Decode(imageBase64), 
      mimeType || 'image/jpeg', 
      filename
    );
    const file = folder.createFile(imageBlob);
    return `https://lh3.googleusercontent.com/d/${file.getId()}`;
  } catch (error) {
    Logger.log(`createImageFile Error: ${error.message}`);
    throw new Error(`Failed to save image: ${error.message}`);
  }
}

function deleteImageFile(imageUrl) {
  try {
    if (imageUrl && imageUrl.includes('/d/')) {
      const fileId = imageUrl.split('/d/')[1].split('/')[0];
      DriveApp.getFileById(fileId).setTrashed(true);
    }
  } catch (error) {
    Logger.log(`Could not delete image: ${error.message}`);
    // Don't throw - deletion failure shouldn't stop other operations
  }
}

// --- 10. EMPLOYEE MANAGEMENT ---
function addEmployee(data) {
  Logger.log("Adding employee: " + JSON.stringify(data));
  
  try {
    // Validate input
    if (!data.id || !data.name || !data.imageBase64) {
      return { success: false, message: "Missing required fields: id, name, imageBase64" };
    }
    
    const lock = acquireLock();
    try {
      const sheet = getSheet(EMPLOYEES_SHEET_NAME);
      
      // Check for existing ID
      const lastRow = sheet.getLastRow();
      if (lastRow > 1) {
        const existingIds = sheet.getRange(2, 1, lastRow - 1, 1)
          .getValues()
          .flat()
          .map(id => id.toString());
        
        if (existingIds.includes(data.id.toString())) {
          return { success: false, message: `Employee ID "${data.id}" already exists` };
        }
      }
      
      // Create image file
      const imageUrl = createImageFile(data.imageBase64, data.mimeType, `${data.id}.jpg`);
      
      // Add to sheet
      sheet.appendRow([data.id, data.name, imageUrl]);
      SpreadsheetApp.flush();
      
      return { success: true, message: "Employee added successfully" };
    } finally {
      lock.releaseLock();
    }
  } catch (error) {
    Logger.log(`addEmployee Error: ${error.message}`);
    return { success: false, message: `Failed to add employee: ${error.message}` };
  }
}

function deleteEmployee(data) {
  Logger.log("Deleting employee: " + JSON.stringify(data));
  
  try {
    if (!data.id) {
      return { success: false, message: "Employee ID is required" };
    }
    
    const lock = acquireLock();
    try {
      const sheet = getSheet(EMPLOYEES_SHEET_NAME);
      const dataRange = sheet.getDataRange();
      const values = dataRange.getValues();
      
      const rowIndex = values.findIndex((row, index) => 
        index > 0 && row[0] && row[0].toString() === data.id.toString()
      );
      
      if (rowIndex > 0) {
        const imageUrl = values[rowIndex][2];
        if (imageUrl) {
          deleteImageFile(imageUrl);
        }
        
        sheet.deleteRow(rowIndex + 1);
        SpreadsheetApp.flush();
        return { success: true, message: "Employee deleted successfully" };
      }
      
      return { success: false, message: "Employee not found" };
    } finally {
      lock.releaseLock();
    }
  } catch (error) {
    Logger.log(`deleteEmployee Error: ${error.message}`);
    return { success: false, message: `Failed to delete employee: ${error.message}` };
  }
}

// --- 11. ATTENDANCE LOGGING ---
function logAttendance(data) {
  Logger.log("Logging attendance: " + JSON.stringify(data));
  
  try {
    // Validate input
    if (!data.employeeId || !data.name || !data.imageDataUrl || !data.punchType) {
      return { success: false, message: "Missing required fields: employeeId, name, imageDataUrl, punchType" };
    }
    
    if (!['in', 'out'].includes(data.punchType)) {
      return { success: false, message: "punchType must be 'in' or 'out'" };
    }
    
    const lock = acquireLock(20000);
    try {
      const now = new Date();
      const todayDateString = Utilities.formatDate(now, Session.getScriptTimeZone(), "yyyy-MM-dd");
      const nowIsoString = now.toISOString();
      
      // Get today's record
      const records = getAttendanceRecords();
      const todaysRecord = records.find(r => 
        r.EmployeeID && r.EmployeeID.toString() === data.employeeId.toString() && 
        isSameDate(r.Date, todayDateString)
      );
      
      // Face verification (simplified for now)
      const employee = getEmployeeById(data.employeeId);
      if (!employee) {
        return { success: false, message: "Employee not found" };
      }
      
      // For now, skip Gemini verification to avoid API issues
      // const verification = verifyWithGemini(employee.ReferenceImageURL, data.imageDataUrl);
      // if (!verification.success || !verification.isMatch) {
      //   return { success: false, message: "Face verification failed" };
      // }
      
      const sheet = getSheet(ATTENDANCE_SHEET_NAME);
      let updatedLog;
      
      if (data.punchType === 'in') {
        if (todaysRecord && todaysRecord.PunchInTime) {
          return { success: false, message: "Already punched in for today" };
        }
        
        const imageUrl = createImageFile(
          data.imageDataUrl.split(',')[1], 
          'image/jpeg', 
          `${data.employeeId}-${todayDateString}-IN.jpg`
        );
        
        const logId = Utilities.getUuid();
        const newLogRow = [logId, data.employeeId, data.name, todayDateString, nowIsoString, imageUrl, "", ""];
        sheet.appendRow(newLogRow);
        updatedLog = arrayToLogObject(newLogRow);
        
      } else if (data.punchType === 'out') {
        if (!todaysRecord || !todaysRecord.PunchInTime) {
          return { success: false, message: "Must punch in before punching out" };
        }
        if (todaysRecord.PunchOutTime) {
          return { success: false, message: "Already punched out for today" };
        }
        
        const imageUrl = createImageFile(
          data.imageDataUrl.split(',')[1], 
          'image/jpeg', 
          `${data.employeeId}-${todayDateString}-OUT.jpg`
        );
        
        const rowIndex = findRowIndex(sheet, todaysRecord.LogID, 1);
        if (rowIndex > -1) {
          sheet.getRange(rowIndex, ATTENDANCE_HEADERS.indexOf("PunchOutTime") + 1).setValue(nowIsoString);
          sheet.getRange(rowIndex, ATTENDANCE_HEADERS.indexOf("PunchOutImageURL") + 1).setValue(imageUrl);
          const updatedRowValues = sheet.getRange(rowIndex, 1, 1, ATTENDANCE_HEADERS.length).getValues()[0];
          updatedLog = arrayToLogObject(updatedRowValues);
        } else {
          throw new Error("Could not find record to update for punch-out");
        }
      }
      
      SpreadsheetApp.flush();
      return { success: true, log: updatedLog, message: "Attendance logged successfully" };
    } finally {
      lock.releaseLock();
    }
  } catch (error) {
    Logger.log(`logAttendance Error: ${error.message}`);
    return { success: false, message: `Failed to log attendance: ${error.message}` };
  }
}

function arrayToLogObject(rowArray) {
  const obj = {};
  ATTENDANCE_HEADERS.forEach((header, i) => {
    obj[header] = rowArray[i] === "" ? null : rowArray[i];
  });
  return obj;
}

// --- 12. ADMIN TOKEN VERIFICATION ---
function verifyAdminToken(data) {
  if (!data || !data.token) {
    return { success: false, message: 'Missing token' };
  }
  
  try {
    const url = 'https://oauth2.googleapis.com/tokeninfo?id_token=' + encodeURIComponent(data.token);
    const response = UrlFetchApp.fetch(url, { 
      muteHttpExceptions: true,
      timeout: 30000
    });
    
    if (response.getResponseCode() !== 200) {
      return { success: false, message: 'Token verification failed' };
    }
    
    const info = JSON.parse(response.getContentText());
    
    if (info.error) {
      return { success: false, message: info.error_description || info.error };
    }
    
    return { 
      success: true, 
      user: {
        id: info.sub,
        name: info.name || info.email,
        email: info.email,
        picture: info.picture || ''
      }
    };
  } catch (error) {
    Logger.log(`verifyAdminToken Error: ${error.message}`);
    return { success: false, message: 'Token verification failed: ' + error.message };
  }
}

// --- 13. GEMINI FACE VERIFICATION (DISABLED FOR NOW) ---
function verifyWithGemini(referenceImageUrl, capturedImageDataUrl) {
  // Simplified version - returns success to avoid API issues during testing
  Logger.log("Face verification called (simplified mode)");
  return { success: true, isMatch: true, confidence: 0.9 };
  
  /*
  // Uncomment this when GEMINI_API_KEY is set up properly
  try {
    const apiKey = PropertiesService.getScriptProperties().getProperty('GEMINI_API_KEY');
    if (!apiKey) {
      return { success: true, isMatch: true, confidence: 0.9 }; // Allow for testing
    }
    
    // Implementation here...
    
  } catch (error) {
    Logger.log(`verifyWithGemini Error: ${error.message}`);
    return { success: false, message: 'Face verification failed: ' + error.message };
  }
  */
}

// --- 14. MANUAL TEST FUNCTIONS ---
function testSetup() {
  Logger.log("Running manual setup test...");
  return setupSpreadsheet();
}

function testGetEmployees() {
  Logger.log("Testing getEmployees...");
  const result = getEmployees();
  Logger.log("Employees found: " + result.length);
  Logger.log("Employee data: " + JSON.stringify(result));
  return result;
}

function testGetAttendance() {
  Logger.log("Testing getAttendance...");
  const result = getAttendanceRecords();
  Logger.log("Attendance records found: " + result.length);
  Logger.log("Attendance data: " + JSON.stringify(result));
  return result;
}

function testAddEmployee() {
  Logger.log("Testing addEmployee...");
  const testData = {
    id: "TEST001",
    name: "Test Employee",
    imageBase64: "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==", // 1x1 pixel PNG
    mimeType: "image/png"
  };
  const result = addEmployee(testData);
  Logger.log("Add employee result: " + JSON.stringify(result));
  return result;
}

function testDeleteEmployee() {
  Logger.log("Testing deleteEmployee...");
  const testData = {
    id: "TEST001"
  };
  const result = deleteEmployee(testData);
  Logger.log("Delete employee result: " + JSON.stringify(result));
  return result;
}

function testLogAttendance() {
  Logger.log("Testing logAttendance...");
  const testData = {
    employeeId: "001",
    name: "Test Employee",
    imageDataUrl: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==",
    punchType: "in"
  };
  const result = logAttendance(testData);
  Logger.log("Log attendance result: " + JSON.stringify(result));
  return result;
}

// Direct test functions that simulate the web app calls
function simulateDoGet() {
  Logger.log("Simulating doGet with setup action...");
  const mockEvent = {
    parameter: {
      action: "setup"
    }
  };
  return doGet(mockEvent);
}

function simulateDoGetEmployees() {
  Logger.log("Simulating doGet with getEmployees action...");
  const mockEvent = {
    parameter: {
      action: "getEmployees"
    }
  };
  return doGet(mockEvent);
}

function simulateDoGetAttendance() {
  Logger.log("Simulating doGet with getAttendance action...");
  const mockEvent = {
    parameter: {
      action: "getAttendance"
    }
  };
  return doGet(mockEvent);
}
